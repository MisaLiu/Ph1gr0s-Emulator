"use strict";console.oldWarn=console.warn,console.oldError=console.error,console.msg=[],console.warn=function(e,t){let i=document.getElementById("msg-box"),n=i.getElementsByClassName("mdui-dialog-content")[0];var s;console.msg.length<=0&&(n.innerHTML=""),console.oldWarn(e),t&&console.oldWarn(t),s=this.msg.push(e)-1,n.innerHTML='<div class="mdui-card mdui-shadow-0 mdui-m-b-1 mdui-color-orange-100" id="msg-id-'+s+'"><div class="mdui-card-content mdui-p-b-0"><p style="margin-top:0;"><i class="mdui-icon material-icons mdui-m-r-1">&#xe002;</i>'+e+"</p>"+(t?'<pre style="margin-bottom:0;font-size:14px;overflow;auto;">'+t.message+"\n"+t.stack+"</pre>":"")+'</div><div class="mdui-card-actions"><button onclick="console.deleteMsg('+s+')" class="mdui-btn mdui-ripple mdui-float-right">忽略</button></div></div>'+n.innerHTML,mdui.$("#msg-btn").hasClass("mdui-fab-hide")&&mdui.$("#msg-btn").removeClass("mdui-fab-hide")},console.error=function(e,t){let i=document.getElementById("msg-box"),n=i.getElementsByClassName("mdui-dialog-content")[0],s;console.msg.length<=0&&(n.innerHTML=""),console.oldError(e),t&&console.oldError(t),s=this.msg.push(e)-1,n.innerHTML='<div class="mdui-card mdui-shadow-0 mdui-m-b-1 mdui-color-deep-orange-a700" id="msg-id-'+s+'"><div class="mdui-card-content mdui-p-b-0"><p style="margin-top:0;"><i class="mdui-icon material-icons mdui-m-r-1">&#xe000;</i>'+e+"</p>"+(t?'<pre style="margin-bottom:0;font-size:14px;overflow:auto">'+t.message+"\n"+t.stack+"</pre>":"")+'</div><div class="mdui-card-actions"><button onclick="console.deleteMsg('+s+')" class="mdui-btn mdui-ripple mdui-float-right">忽略</button></div></div>'+n.innerHTML,mdui.confirm(e+(t?'<pre style="margin-bottom:0;font-size:14px;overflow:auto">'+t.message+"\n"+t.stack+"</pre>":""),"出错啦！",()=>{console.deleteMsg(s)},()=>{},{confirmText:"忽略",cancelText:"关闭"}),mdui.$("#msg-btn").hasClass("mdui-fab-hide")&&mdui.$("#msg-btn").removeClass("mdui-fab-hide")},console.openMsgBox=()=>{let e=new mdui.Dialog("#msg-box");e.open()},console.deleteMsg=e=>{let t=new mdui.Dialog("#msg-box");if(mdui.$("#msg-id-"+e).remove(),console.msg.splice(e,1),console.msg.length<=0){let e=document.getElementById("msg-box"),t=e.getElementsByClassName("mdui-dialog-content")[0];t.innerHTML='<div class="mdui-text-center mdui-text-color-theme-disabled">还没有新信息哦</div>',mdui.$("#msg-btn").hasClass("mdui-fab-hide")||mdui.$("#msg-btn").addClass("mdui-fab-hide")}mdui.mutation("#msg-box"),t.handleUpdate()};class Click{constructor(e,t,i=null,n=null){this.offsetX=Number(e),this.offsetY=Number(t),this.isMoving=!1,this.time=0,this.type=i,this.inputId=Number(n)}static activate(e,t,i=null,n=null){return inputs.taps.push(new Click(e,t,i,n)),e<1.5*pixi.renderer.lineScale&&t<1.5*pixi.renderer.lineScale&&specialClick.click(0),e>pixi.renderer.realWidth-1.5*pixi.renderer.lineScale&&t<1.5*pixi.renderer.lineScale&&specialClick.click(1),e<1.5*pixi.renderer.lineScale&&t>pixi.renderer.realHeight-1.5*pixi.renderer.lineScale&&specialClick.click(2),e>pixi.renderer.realWidth-1.5*pixi.renderer.lineScale&&t>pixi.renderer.realHeight-1.5*pixi.renderer.lineScale&&specialClick.click(3),new Click(e,t,i,n)}move(e,t){this.offsetX=Number(e),this.offsetY=Number(t),this.isMoving=!0,this.time=0}animate(){this.time++?DrawInputPoint(this.offsetX,this.offsetY,this.type,this.inputId,2):this.isMoving?DrawInputPoint(this.offsetX,this.offsetY,this.type,this.inputId,1):DrawInputPoint(this.offsetX,this.offsetY,this.type,this.inputId,0)}}class Judgement{constructor(e,t,i){this.offsetX=Number(e),this.offsetY=Number(t),this.type=Number(i)||0,this.catched=!1}isInArea(e,t,i,n,s,o=0){let r=(this.offsetX-e)*i+(this.offsetY-t)*n;return r=0<r?r:-r,r<=s}}class Judgements extends Array{addJudgement(e,t){if(!stat.isPaused)if(this.length=0,settings.autoPlay)for(const l of e){var i,n;0<l.score&&(l.isProcessed||l.isScored)||l.realTime-t>global.judgeTimes.bad||(i=getNotePosition(l,!1).x,n=getNotePosition(l,!1).y,1==l.type?l.realTime-t<0&&this.push(new Judgement(i,n,1)):2==l.type?l.realTime-t<global.judgeTimes.bad&&this.push(new Judgement(i,n,2)):3==l.type?l.isPressing?this.push(new Judgement(i,n,2)):l.realTime-t<0&&this.push(new Judgement(i,n,1)):4==l.type&&l.realTime-t<global.judgeTimes.bad&&this.push(new Judgement(i,n,3)))}else{for(var s in inputs.mouse){s=inputs.mouse[s];s instanceof Click&&(s.time?this.push(new Judgement(s.offsetX,s.offsetY,2)):s.isMoving&&this.push(new Judgement(s.offsetX,s.offsetY,3)))}for(var o in inputs.touches){o=inputs.touches[o];o instanceof Click&&(o.time?this.push(new Judgement(o.offsetX,o.offsetY,2)):o.isMoving&&this.push(new Judgement(o.offsetX,o.offsetY,3)))}for(var r in inputs.keyboard){r=inputs.keyboard[r];r instanceof Click&&(r.time?this.push(new Judgement(r.offsetX,r.offsetY,2)):this.push(new Judgement(r.offsetX,r.offsetY,3)))}for(var a of inputs.taps)a instanceof Click&&this.push(new Judgement(a.offsetX,a.offsetY,1))}}judgeNote(e,t,i){if(stat.isTransitionEnd&&!stat.isPaused)for(const d of e){var n=d.realTime-t,s=0<n?n:-n;if(!(0<d.score&&d.isProcessed)&&!(n>global.judgeTimes.bad))if(!(n<-global.judgeTimes.bad)||d.isProcessed||d.isPressing||d.isScored){var o=getNotePosition(d,!1).x,r=getNotePosition(d,!1).y,a=d.parent.parent.cosr,l=d.parent.parent.sinr;if(1==d.type){for(let e=0;e<this.length;e++)if(1==this[e].type&&this[e].isInArea(o,r,a,l,i)&&s<=global.judgeTimes.bad&&!d.isProcessed&&(s<=global.judgeTimes.perfect?d.score=4:s<=global.judgeTimes.good?d.score=3:d.score=2,0<d.score)){score.addCombo(d.score,n),d.visible=!1,CreateClickAnimation(d,settings.performanceMode),settings.hitsound&&2<d.score&&textures.sound.tap.play({volume:settings.hitsoundVolume}),sprites.accIndicator&&sprites.accIndicator.pushAccurate(d.realTime,t),d.isProcessed=!0,this.splice(e,1);break}}else if(2==d.type){if(0<d.score&&n<0&&!d.isProcessed)score.addCombo(d.score),d.visible=!1,CreateClickAnimation(d,settings.performanceMode),settings.hitsound&&textures.sound.drag.play({volume:settings.hitsoundVolume}),sprites.accIndicator&&sprites.accIndicator.pushAccurate(d.realTime,t),d.isProcessed=!0;else if(!d.isProcessed)for(let e=0;e<this.length;e++)if(this[e].isInArea(o,r,a,l,i)&&s<=global.judgeTimes.good){this[e].catched=!0,d.score=4;break}}else if(3==d.type)if(d.isPressing&&d.pressTime&&((Date.now()-d.pressTime)*d.holdTime>=16e3*d.realHoldTime&&!d.isScored&&(CreateClickAnimation(d,settings.performanceMode),d.pressTime=Date.now()),d.realTime+d.realHoldTime-global.judgeTimes.bad<t&&d.isPressing))0<d.score&&!d.isScored&&(score.addCombo(d.score,d.accType),d.isScored=!0),d.realTime+d.realHoldTime<t&&(d.visible=!1,d.isProcessed=!0);else{d.isPressing=!1;for(let e=0;e<this.length;e++)if(d.pressTime||d.isPrecessed||d.isScored)d.isScored||d.isProcessed||!this[e].isInArea(o,r,a,l,i)||(d.isPressing=!0);else if(1==this[e].type&&this[e].isInArea(o,r,a,l,i)&&s<global.judgeTimes.good){s<=global.judgeTimes.perfect?d.score=4:d.score=3,d.isPressing=!0,d.accType=n,d.pressTime=Date.now(),CreateClickAnimation(d,settings.performanceMode),settings.hitsound&&textures.sound.tap.play({volume:settings.hitsoundVolume}),sprites.accIndicator&&sprites.accIndicator.pushAccurate(d.realTime,t),this.splice(e,1);break}stat.isPaused||!(0<d.score)||d.isPressing||d.pressTime||d.isScored||(d.score=1,score.addCombo(1),d.isScored=!0,d.alpha=.5)}else if(4==d.type)if(0<d.score&&n<0&&!d.isProcessed)d.visible=!1,score.addCombo(d.score),CreateClickAnimation(d,settings.performanceMode),settings.hitsound&&textures.sound.flick.play({volume:settings.hitsoundVolume}),sprites.accIndicator&&sprites.accIndicator.pushAccurate(d.realTime,t),d.isProcessed=!0;else if(!d.isProcessed)for(let e=0;e<this.length;e++)if(this[e].isInArea(o,r,a,l,i)&&s<=global.judgeTimes.good&&(this[e].catched=!0,3==this[e].type)){d.score=4;break}}else score.addCombo(1),d.score=1,d.isProcessed=!0,d.isScored=!0,3==d.type&&(d.alpha=.5,d.isProcessed=!1)}}}global.functions={},global.functions.resizeCanvas=function(){var e;pixi&&(e=document.getElementById("game-canvas-box"),stat.isFullscreen&&fullscreen.check(pixi.view)?pixi.renderer.resize(document.documentElement.clientWidth,document.documentElement.clientHeight):(stat.isFullscreen&&pixi.renderer.resize(1,1),pixi.renderer.resize(e.offsetWidth,e.offsetWidth*(1/settings.windowRatio)),stat.isFullscreen=!1),pixi.renderer.realWidth=pixi.renderer.width/pixi.renderer.resolution,pixi.renderer.realHeight=pixi.renderer.height/pixi.renderer.resolution,pixi.renderer.fixedWidth=pixi.renderer.realWidth<=pixi.renderer.realHeight/9*16?pixi.renderer.realWidth:pixi.renderer.realHeight/9*16,pixi.renderer.fixedWidthOffset=(pixi.renderer.realWidth-pixi.renderer.fixedWidth)/2,pixi.renderer.noteSpeed=.6*pixi.renderer.realHeight,pixi.renderer.noteScale=pixi.renderer.fixedWidth/settings.noteScale,pixi.renderer.lineScale=pixi.renderer.fixedWidth>.75*pixi.renderer.realHeight?pixi.renderer.realHeight/18.75:pixi.renderer.fixedWidth/14.0625,ResizeChartSprites(sprites,pixi.renderer.realWidth,pixi.renderer.realHeight,settings.noteScale))},global.functions.sortNote=(e,t)=>e.realTime-t.realTime||e.lineId-t.lineId||e.id-t.id;const score={init:function(e,t=!1){return this.totalNotes=e,this.challenge=t,this.score=0,this.combo=0,this.maxCombo=0,this.judge=0,this.apType=2,this.perfect=0,this.good=0,this.bad=0,this.miss=0,this.acc=0,this.perfectAcc=[0,0],this.goodAcc=[0,0],this.badAcc=[0,0],this.missAcc=[0,0],this.scorePerNote=(t?1e6:9e5)/e,this},addCombo:function(e,t=0){for(4==e?(this.perfect+=1,this.combo+=1,t&&(this.perfectAcc[t<0?0:1]+=1)):3==e?(this.good+=1,this.combo+=1,t&&(this.goodAcc[t<0?0:1]+=1)):2==e?(this.bad+=1,this.combo=0,t&&(this.badAcc[t<0?0:1]+=1)):(this.miss+=1,this.combo=0,t&&(this.missAcc[t<0?0:1]+=1)),this.combo>this.maxCombo&&(this.maxCombo=this.combo),this.score=this.scorePerNote*this.perfect+this.scorePerNote*this.good*.65,this.challenge||(this.score+=this.maxCombo/this.totalNotes*1e5),this.score=this.score.toFixed(0),this.score<7e5&&0<this.score?this.judge=0:this.score<82e4&&7e5<=this.score?this.judge=1:this.score<88e4&&82e4<=this.score?this.judge=2:this.score<92e4&&88e4<=this.score?this.judge=3:this.score<96e4&&92e4<=this.score?this.judge=4:this.score<1e6&&96e4<=this.score?this.judge=5:1e6==this.score?this.judge=6:this.judge=-1,this.acc=((this.perfect+.65*this.good)/(this.perfect+this.good+this.bad+this.miss)*100).toFixed(2),this.scoreText=this.score+"";this.scoreText.length<7;)this.scoreText="0"+this.scoreText;if((0<this.bad||0<this.miss)&&0<this.apType){if(this.apType=0,settings.showApStatus)for(var i of sprites.containers)i.children[0].tint=16777215}else if(0<this.good&&1<this.apType&&(this.apType=1,settings.showApStatus))for(var n of sprites.containers)n.children[0].tint=11854335;if(sprites.scoreText.text=this.scoreText,2<this.combo?(sprites.comboText.alpha=1,sprites.comboText.children[0].text=this.combo):sprites.comboText.alpha=0,sprites.judgeRealTime){switch(this.judge){case 0:sprites.judgeRealTime.judge.text="Judge: False";break;case 1:sprites.judgeRealTime.judge.text="Judge: C";break;case 2:sprites.judgeRealTime.judge.text="Judge: B";break;case 3:sprites.judgeRealTime.judge.text="Judge: A";break;case 4:sprites.judgeRealTime.judge.text="Judge: S";break;case 5:sprites.judgeRealTime.judge.text="Judge: V";break;case 6:sprites.judgeRealTime.judge.text="Judge: Phi";break;default:sprites.judgeRealTime.judge.text="Judge: None"}sprites.judgeRealTime.acc.text="Acc: "+this.acc+"%",sprites.judgeRealTime.perfect.text="Perfect: "+this.perfect,sprites.judgeRealTime.good.text="Good: "+this.good,sprites.judgeRealTime.bad.text="Bad: "+this.bad,sprites.judgeRealTime.miss.text="Miss: "+this.miss}return this}},fullscreen={toggle(e,t=!1){if(this.element){if(!t){if(document.exitFullscreen)return document.exitFullscreen();if(document.cancelFullScreen)return document.cancelFullScreen();if(document.webkitCancelFullScreen)return document.webkitCancelFullScreen();if(document.mozCancelFullScreen)return document.mozCancelFullScreen();if(document.msExitFullscreen)return document.msExitFullscreen()}return this.element==e?(e.style.position="relative",e.style.top="unset",e.style.left="unset",e.style.zIndex="unset",document.body.style.overflow="auto",document.inDocumentFullscreenElement=null,global.functions.resizeCanvas&&global.functions.resizeCanvas(),!0):!1}if(!t){if((e=!(e instanceof HTMLElement)?document.body:e).requestFullscreen)return e.requestFullscreen();if(e.webkitRequestFullscreen)return e.webkitRequestFullscreen();if(e.mozRequestFullScreen)return e.mozRequestFullScreen();if(e.msRequestFullscreen)return e.msRequestFullscreen()}return e!=document.body&&(e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.zIndex="5050",document.body.style.overflow="hidden",document.inDocumentFullscreenElement=e,global.functions.resizeCanvas&&global.functions.resizeCanvas(),!0)},check(e){return e instanceof HTMLElement||(e=document.body),this.element==e},get element(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.inDocumentFullscreenElement},get enabled(){return!!(document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled)},get type(){return document.inDocumentFullscreenElement?2:document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement?1:0}},specialClick={clicks:[0,0,0,0],functions:[()=>{gamePause()},()=>{gameRestart()},()=>{},()=>{setCanvasFullscreen()}],click:function(e){var t=Date.now();t-this.clicks[e]<300&&this.functions[e](),this.clicks[e]=t}};function setProgress(e,t,i=null){let n=document.getElementById(e),s=n.getElementsByClassName("text")[0],o=n.getElementsByClassName("progress")[0];o=o.getElementsByTagName("div")[0],n&&(s.innerHTML=t,null!=i&&0<=i?(o.className="mdui-progress-determinate",o.style.width=100*i+"%"):o.className="mdui-progress-indeterminate",mdui.mutation(n))}function createSelection(e,i,n=null){let s=document.getElementById(e);if(s.innerHTML="",i instanceof Array)for(let t=0;t<i.length;t++){var o=i[t];let e=document.createElement("option");e.value=t,e.innerHTML=n?o[n]:o,s.appendChild(e)}else if(i instanceof Object)for(var t in i){let e=document.createElement("option");e.innerHTML=e.value=t,s.appendChild(e)}}function createMenuItems(e,n,s,t=null,o=null,r=null,a=null,l=null){let d=document.getElementById(e),c=NaN;d.innerHTML="";let u=document.createElement("div"),h=document.createElement("a");if(n instanceof Array)for(let i=0;i<n.length;i++){let e=n[i],t="";0!=(o?e[o]:e).indexOf(".")&&(u=document.createElement("div"),h=document.createElement("a"),-1==r&&isNaN(c)||r==i?(t='<i class="mdui-menu-item-icon mdui-icon material-icons">&#xe5ca;</i>',c=i):t='<i class="mdui-menu-item-icon mdui-icon material-icons"></i>',t+=o?e[o]:e,h.setAttribute("onclick","selectMenuItem('"+d.id.replace(/'/g,"'")+"', this"+(l?", '"+l+"'":"")+");"+s+" = '"+i+"'"+(a?";"+a:"")),h.setAttribute("menu-value",o?e[o]:e),h.className="mdui-ripple",u.className="mdui-menu-item",h.innerHTML=t,u.appendChild(h),d.appendChild(u))}else if(n instanceof Object)for(var i in n){let e="";0!=i.indexOf(".")&&(u=document.createElement("div"),h=document.createElement("a"),-1==r&&isNaN(c)||r==i?(e='<i class="mdui-menu-item-icon mdui-icon material-icons">&#xe5ca;</i>'+i,c=0):e='<i class="mdui-menu-item-icon mdui-icon material-icons"></i>'+i,h.setAttribute("onclick","selectMenuItem('"+d.id.replace(/'/g,"'")+"', this"+(l?", '"+l+"'":"")+");"+s+" = "+t+"['"+i.replace(/'/g,"'")+"']"+(a?";"+a:"")),h.setAttribute("menu-value",i),h.className="mdui-ripple",u.className="mdui-menu-item",h.innerHTML=e,u.appendChild(h),d.appendChild(u))}isNaN(c)||selectMenuItem(d.id,h,l),mdui.mutation(d)}function selectMenuItem(e,t,i=null){let n=document.getElementById(e);var s;for(s of n.getElementsByClassName("mdui-menu-item")){let e=s.getElementsByTagName("a")[0],t=e.getElementsByClassName("mdui-menu-item-icon")[0];t.innerHTML=""}t.getElementsByClassName("mdui-menu-item-icon")[0].innerHTML="&#xe5ca;",i&&(document.getElementById(i).innerHTML="当前选择了："+t.getAttribute("menu-value"))}function BlurImage(e,t=10){var i=document.createElement("canvas");let n=null;return n=e instanceof PIXI.BaseTexture?e.resource.source:e,StackBlur.image(n,i,t),i}function CalculateChartData(i){let u=[],n=[],e={},h={tap:[],drag:[],hold:[],flick:[]};for(let e=0;e<i.judgeLineList.length;e++){var s=i.judgeLineList[e];let t={id:e,bpm:s.bpm,speedEvents:[],judgeLineMoveEvents:[],judgeLineRotateEvents:[],judgeLineDisappearEvents:[],notes:[],notesAbove:[],notesBelow:[],numOfNotes:s.numOfNotes,numOfNotesAbove:s.numOfNotesAbove,numOfNotesBelow:s.numOfNotesBelow};if(!(s.notesAbove.length<=0&&s.notesBelow<=0&&s.judgeLineMoveEvents.length<=1&&s.judgeLineRotateEvents.length<=1&&s.judgeLineDisappearEvents.length<=1&&s.speedEvents.length<=1)){t.speedEvents=c(function(e){let t=[];for(var i of e){let e=t[t.length-1];e&&e.value==i.value?e.endTime=i.endTime:t.push(i)}return JSON.parse(JSON.stringify(t))}(s.speedEvents),s.bpm),t.judgeLineMoveEvents=c(d(s.judgeLineMoveEvents),s.bpm),t.judgeLineRotateEvents=c(d(s.judgeLineRotateEvents),s.bpm),t.judgeLineDisappearEvents=c(d(s.judgeLineDisappearEvents),s.bpm);for(let e=0;e<s.notesAbove.length;e++){var o=l(o=s.notesAbove[e],t,e,!0);t.notes.push(o),t.notesAbove.push(o)}for(let e=0;e<s.notesBelow.length;e++){var r=l(r=s.notesBelow[e],t,e,!1);t.notes.push(r),t.notesBelow.push(r)}n.push(t)}}for(var t of u)e[t.realTime.toFixed(6)]=e[t.realTime.toFixed(6)]?2:1;for(var a of u)a.isMulti=2==e[a.realTime.toFixed(6)];return h.tap.sort(global.functions.sortNote),h.drag.sort(global.functions.sortNote),h.hold.sort(global.functions.sortNote),h.flick.sort(global.functions.sortNote),u.sort(global.functions.sortNote),h.total=u,{judgeLines:n,notes:h,offset:i.offset};function l(e,t,i,n){let s=1,o=0,r=0;var a;let l=0;if(e.realTime=e.time*(1.875/t.bpm),e.realHoldTime=e.holdTime*(1.875/t.bpm),e.offsetY=e.floorPosition,e.holdLength=e.realHoldTime*e.speed,e.lineId=t.id,e.id=i,e.isAbove=n,e.score=0,e.isScored=!1,e.isProcessed=!1,e.isPressing=!1,e.pressTime=0,e.accType=0,!e.offsetY){for(var d of t.speedEvents)if(!(e.realTime<d.startRealTime||e.realTime>d.endRealTime)){s=d.value,r=d.floorPosition,o=d.startRealTime;break}e.offsetY=(e.realTime-o)*s+r}if(!e.holdLength){a=e.realTime+e.realHoldTime,n=(e.realTime-o)*s+r;for(var c of t.speedEvents)if(!(a<c.startRealTime||a>c.endRealTime)){l=(a-c.startRealTime)*c.value+c.floorPosition;break}e.holdEndPosition=l,e.holdLength=l-n}return 1==e.type?h.tap.push(e):2==e.type?h.drag.push(e):3==e.type?h.hold.push(e):4==e.type&&h.flick.push(e),u.push(e),e}function d(e){let t=JSON.parse(JSON.stringify(e)),i=[],n=[{startTime:1-1e6,endTime:0,start:t[0]?t[0].start:0,end:t[0]?t[0].end:0,start2:t[0]?t[0].start2:0,end2:t[0]?t[0].end2:0}];t.push({startTime:0,endTime:1e9,start:t[t.length-1]?t[t.length-1].start:0,end:t[t.length-1]?t[t.length-1].end:0,start2:t[t.length-1]?t[t.length-1].start2:0,end2:t[t.length-1]?t[t.length-1].end2:0});for(var s of t){var o=n[n.length-1];o.endTime>s.endTime||(o.endTime==s.startTime?n.push(s):o.endTime<s.startTime?n.push({startTime:o.endTime,endTime:s.startTime,start:o.end,end:o.end,start2:o.end2,end2:o.end2},s):o.endTime>s.startTime&&n.push({startTime:o.endTime,endTime:s.endTime,start:(s.start*(s.endTime-o.endTime)+s.end*(o.endTime-s.startTime))/(s.endTime-s.startTime),end:o.end,start2:(s.start2*(s.endTime-o.endTime)+s.end2*(o.endTime-s.startTime))/(s.endTime-s.startTime),end2:o.end2}))}i=[n.shift()];for(var r of n){let e=i[i.length-1];var a=e.endTime-e.startTime,l=r.endTime-r.startTime;r.startTime==r.endTime||(e.end==r.start&&e.end2==r.start2&&(e.end-e.start)*l==(r.end-r.start)*a&&(e.end2-e.start2)*l==(r.end2-r.start2)*a?(e.endTime=r.endTime,e.end=r.end,e.end2=r.end2):i.push(r))}return JSON.parse(JSON.stringify(i))}function c(e,t){for(var i of e)i.startRealTime=i.startTime/t*1.875,i.endRealTime=i.endTime/t*1.875,i.startDeg=-Math.PI/180*i.start,i.endDeg=-Math.PI/180*i.end;return e}}function CreateChartSprites(e,o){var s,r=o.renderer.realWidth,a=o.renderer.realHeight,l=o.renderer.fixedWidth,d=(o.renderer.fixedWidthOffset,o.renderer.lineScale),c=o.renderer.noteScale;let u={containers:[],totalNotes:[],tapholeNotes:[],dragNotes:[],flickNotes:[],inputs:{touches:{},mouse:{}},clickAnimate:[]};if(settings.background){let e=new PIXI.Sprite(settings.backgroundBlur?_chart.imageBlur:_chart.image);var i=l/_chart.image.width,n=a/_chart.image.height,n=n<i?i:n;let t=new PIXI.Graphics;t.beginFill(0),t.drawRect(0,0,e.width,e.height),t.endFill(),t.position.x=-e.width/2,t.position.y=-e.height/2,t.alpha=1-settings.backgroundDim,e.addChild(t),e.anchor.set(.5),e.scale.set(n),e.position.set(r/2,a/2),u.background=e,o.stage.addChild(e)}for(s of e.judgeLines){let e=new PIXI.Container,t=new PIXI.Sprite(textures.judgeLine),i=new PIXI.Container,n=new PIXI.Container;for(var h in s)t[h]=s[h];if(t.anchor.set(.5),t.height=18.75*d*.008,t.width=t.height*t.texture.width/t.texture.height*1.042,t.position.set(0,0),t.zIndex=1,settings.showApStatus&&(t.tint=16772256),settings.developMode){let e=new PIXI.Text(s.id,{fill:"rgb(255,100,100)"});e.anchor.set(.5,1),e.position.set(0),t.addChild(e)}i.noteDirection=1,n.noteDirection=-1;for(var p of s.notes){let s;if(3==p.type){let e=new PIXI.Container,t=new PIXI.Sprite(textures["holdHead"+(p.isMulti&&settings.multiNotesHighlight?"Hl":"")]),i=new PIXI.Sprite(textures["holdBody"+(p.isMulti&&settings.multiNotesHighlight?"Hl":"")]),n=new PIXI.Sprite(textures["holdEnd"+(p.isMulti&&settings.multiNotesHighlight?"Hl":"")]);t.anchor.set(.5),i.anchor.set(.5,1),n.anchor.set(.5,1),i.height=p.holdLength*o.renderer.noteSpeed/c,t.position.set(0,t.height/2),i.position.set(0,0),n.position.set(0,-i.height),e.addChild(t),e.addChild(i),e.addChild(n),e.zIndex=2,s=e}else s=new PIXI.Sprite(textures.tap),s.anchor.set(.5),s.zIndex=3,1==p.type?s.texture=textures["tap"+(p.isMulti&&settings.multiNotesHighlight?"Hl":"")]:2==p.type?s.texture=textures["drag"+(p.isMulti&&settings.multiNotesHighlight?"Hl":"")]:4==p.type&&(s.texture=textures["flick"+(p.isMulti&&settings.multiNotesHighlight?"Hl":"")]);if(settings.developMode){let e=new PIXI.Text(p.lineId+(p.isAbove?"+":"-")+p.id,{fill:"rgb(100,255,100)"});e.scale.set(1/(o.renderer.width/settings.noteScale)),e.anchor.set(.5,1),e.position.set(0),s.addChild(e)}for(var m in s.scale.set(c),s.position.x=.109*p.positionX.toFixed(6)*(l/2),s.position.y=p.offsetY*(.6*a)*(p.isAbove?-1:1),p)s[m]=p[m];p.isAbove?i.addChild(s):(s.angle=180,n.addChild(s)),u.totalNotes.push(s)}u.totalNotes.sort(global.functions.sortNote),e.addChild(t),0<i.children.length&&e.addChild(i),0<n.children.length&&e.addChild(n),o.stage.addChild(e),e.position.x=r/2,e.position.y=a/2,u.containers.push(e)}return u}function CreateChartInfoSprites(n,s,e=!1){var o=s.renderer.realWidth,r=s.renderer.realHeight,a=s.renderer.fixedWidth,l=s.renderer.fixedWidthOffset,d=s.renderer.lineScale;if(n.headInfos||(n.headInfos=new PIXI.Container),n.headInfos.parent||s.stage.addChild(n.headInfos),!n.progressBar){let e=new PIXI.Sprite(textures.progressBar);e.anchor.x=1,e.scale.set(a/(1920/s.renderer.resolution)),n.headInfos.addChild(e),n.progressBar=e}if(!n.scoreText){let e=new PIXI.Text("0000000",{fontFamily:"Mina",fontSize:.95*d+"px",fill:"white"});e.anchor.x=1,e.anchor.y=.5,n.headInfos.addChild(e),n.scoreText=e}if(!n.comboText){let e=new PIXI.Container,t=new PIXI.Text("0",{fontFamily:"Mina",fontSize:1.32*d+"px",fill:"white"}),i=new PIXI.Text("combo",{fontFamily:"Mina",fontSize:.66*d+"px",fill:"white"});settings.autoPlay&&(i.text="Autoplay"),t.anchor.set(.5),i.anchor.set(.5,1),e.addChild(t),e.addChild(i),n.headInfos.addChild(e),n.comboText=e}if(n.titlesBig||(n.titlesBig=new PIXI.Container,s.stage.addChild(n.titlesBig)),!n.songTitleBig){let e=new PIXI.Text(_chart.info.name||"No Title",{fontFamily:"Mina",fontSize:1.1*d+"px",fill:"white",align:"center"});e.anchor.x=.5,n.titlesBig.addChild(e),n.songTitleBig=e}if(!n.bgAuthorBig){let e=new PIXI.Text("Illustration designed by "+(_chart.info.illustrator||"No name"),{fontFamily:"Mina",fontSize:.55*d+"px",fill:"white",align:"center"});e.anchor.set(.5,1),n.titlesBig.addChild(e),n.bgAuthorBig=e}if(!n.chartAuthorBig){let e=new PIXI.Text("Level designed by "+(_chart.info.designer||"No name"),{fontFamily:"Mina",fontSize:.55*d+"px",fill:"white",align:"center"});e.anchor.set(.5,1),n.titlesBig.addChild(e),n.chartAuthorBig=e}if(n.footInfos||(n.footInfos=new PIXI.Container),n.footInfos.parent||s.stage.addChild(n.footInfos),n.songNameBar||(n.songNameBar=new PIXI.Sprite(textures.songNameBar),n.songNameBar.width=.119*d,n.songNameBar.height=.612*d,n.footInfos.addChild(n.songNameBar)),n.songTitle||(n.songTitle=new PIXI.Text(_chart.info.name||"No title",{fontFamily:"Mina",fontSize:.63*d+"px",fill:"white",align:"center"}),n.songTitle.anchor.y=1,n.footInfos.addChild(n.songTitle)),n.songDiff||(n.songDiff=new PIXI.Text(_chart.info.level||"SP Lv.?",{fontFamily:"Mina",fontSize:.63*d+"px",fill:"white",align:"right"}),n.songDiff.anchor.set(1),n.footInfos.addChild(n.songDiff)),!n.backgroundCover){let e=new PIXI.Sprite(settings.backgroundBlur?_chart.imageBlur:_chart.image),t=new PIXI.Graphics,i=new PIXI.Container;var c=o/_chart.image.width,u=r/_chart.image.height,u=u<c?c:u;t.beginFill(0),t.drawRect(0,0,e.width,e.height),t.endFill(),t.position.set(-e.width/2,-e.height/2),t.alpha=.5,e.addChild(t),e.anchor.set(.5),e.scale.set(u),e.position.set(o/2,r/2),e.alpha=o!=a?1:0,s.stage.addChild(e),i.addChild((new PIXI.Graphics).beginFill(16777215).drawRect(0,0,l,r).endFill(),(new PIXI.Graphics).beginFill(16777215).drawRect(o-l,0,l,r).endFill()),e.mask=i,n.backgroundCover={image:e,cover:i}}if(e&&!n.fps){let e=new PIXI.Text("00.00",{fontFamily:"Mina",fontSize:.8*d+"px",fill:"rgba(255, 255, 255, 0.5)",align:"right"});e.anchor.set(1,0),s.stage.addChild(e),n.fps=e,n.fpsInterval=setInterval(()=>{e.text=function(e){e=(e+"").split(".");for(var t of e)t<10&&(t="0"+t);return e[0]+(e[1]?"."+e[1]:"")}(s.ticker.FPS.toFixed(2))},200)}if(!n.watermark){let e=new PIXI.Text("Ph1gr0s Emulator v1.0.0 Beta By MisaLiu Origin By lchzh3473",{fontFamily:"Mina",fontSize:.6*d+"px",fill:"rgba(255, 255, 255, 0.5)",align:"right"});e.anchor.set(1),s.stage.addChild(e),n.watermark=e}n.comboText.alpha=0,n.titlesBig.alpha=0,n.headInfos.alpha=0,n.footInfos.alpha=0,n.scoreText.position.set(a-.65*d+l,1.375*d),n.comboText.position.x=o/2,n.comboText.children[0].position.y=1.375*d,n.comboText.children[1].position.y=1.375*d+n.comboText.children[0].height,n.songTitleBig.position.x=o/2,n.songTitleBig.position.y=r/2*.75,n.bgAuthorBig.position.x=o/2,n.bgAuthorBig.position.y=r/2*1.25+.15*d,n.chartAuthorBig.position.x=o/2,n.chartAuthorBig.position.y=r/2*1.25+d,n.songNameBar.position.x=.53*d+l,n.songNameBar.position.y=r-1.22*d,n.songTitle.position.x=.85*d+l,n.songTitle.position.y=r-.52*d,n.songDiff.position.x=o-.75*d-l,n.songDiff.position.y=r-.52*d,n.fps.position.set(o-1,1),n.watermark.position.set(o-2,r-2),n.headInfos.position.y=-n.headInfos.height,n.footInfos.position.y=n.headInfos.height}function CreateGameEndAnimate(e){var t=pixi.renderer.realWidth,i=pixi.renderer.realHeight,n=(pixi.renderer.fixedWidth,pixi.renderer.fixedWidthOffset,pixi.renderer.lineScale),s=27.621528*n,o=14.461806*n,r=1.111111*n,a=13.680556*n,l=.399306*n,d=a/_chart.image.width,c=a/_chart.image.height,c=c<d?d:c;let u=e;switch(u||(u={},u.container=new PIXI.Container,u.bgRect=new PIXI.Graphics,u.image={image:new PIXI.Sprite,gradient:new PIXI.Graphics,cover:new PIXI.Graphics,songName:new PIXI.Text("",{fontFamily:"Mina",fill:"white"}),songDiff:new PIXI.Text("",{fontFamily:"Mina",fill:"white"}),retryBtn:new PIXI.Graphics},u.judgeIcon=new PIXI.Sprite,u.newScore=new PIXI.Text("",{fontFamily:"Mina",fill:"white"}),u.score=new PIXI.Text("",{fontFamily:"Mina",fill:"white"}),u.judge={container:new PIXI.Container,perfect:new PIXI.Text("",{fontFamily:"Mina",fill:"white"}),good:new PIXI.Text("",{fontFamily:"Mina",fill:"white"}),bad:new PIXI.Text("",{fontFamily:"Mina",fill:"white"}),miss:new PIXI.Text("",{fontFamily:"Mina",fill:"white"})},u.acc={container:new PIXI.Container,percent:new PIXI.Text("",{fontFamily:"Mina",fill:"white"}),apType:new PIXI.Text("",{fontFamily:"Mina",fill:"white"})},u.container.addChild(u.bgRect),u.image.image.addChild(u.image.gradient),u.container.addChild(u.image.image,u.image.cover,u.image.songName,u.image.songDiff,u.image.retryBtn),u.container.addChild(u.judgeIcon),u.container.addChild(u.newScore),u.container.addChild(u.score),u.judge.container.addChild(u.judge.perfect,u.judge.good,u.judge.bad,u.judge.miss),u.container.addChild(u.judge.container),u.acc.container.addChild(u.acc.percent,u.acc.apType),u.container.addChild(u.acc.container),pixi.stage.addChild(u.container)),u.image.image.texture=_chart.image,score.judge){case 0:u.judgeIcon.texture=textures.judgeIcon.false;break;case 1:u.judgeIcon.texture=textures.judgeIcon.c;break;case 2:u.judgeIcon.texture=textures.judgeIcon.b;break;case 3:u.judgeIcon.texture=textures.judgeIcon.a;break;case 4:u.judgeIcon.texture=textures.judgeIcon.s;break;case 5:u.judgeIcon.texture=textures.judgeIcon.v;break;case 6:u.judgeIcon.texture=textures.judgeIcon.phi}return u.bgRect.clear(),u.bgRect.beginFill(16777215,.11).drawRoundedRect(0,0,s,o,.78125*n).endFill(),u.image.gradient.clear(),u.image.gradient.beginFill(0).drawRect(-u.image.image.width/2,-27.5,u.image.image.width,50).endFill(),u.image.cover.clear(),u.image.cover.beginFill(16777215).drawRoundedRect(0,0,a,a,.520833*n).endFill(),u.image.retryBtn.clear(),u.image.retryBtn.beginFill(0,.6).drawRoundedRect(0,0,3.802083*n,1.336806*n,.347222*n).endFill(),u.image.retryBtn.children[0]||(u.image.retryBtn.addChild(new PIXI.Text("重试",{fontFamily:"Mina",fill:"white"})),u.image.retryBtn.interactive=!0,u.image.retryBtn.buttonMode=!0,u.image.retryBtn.on("pointerdown",()=>{gameRestart()})),u.image.songName.text=_chart.info.name||"No name",u.image.songDiff.text=_chart.info.level||"SP Lv.?",u.newScore.text="Max combo: "+score.maxCombo,u.score.text=score.scoreText,u.judge.perfect.text="Perfect "+score.perfect,u.judge.good.text="Good "+score.good,u.judge.bad.text="Bad "+score.bad,u.judge.miss.text="Miss "+score.miss,u.acc.apType.text=2==score.apType?"All Perfect":1==score.apType?"Full Combo":"",u.acc.percent.text=score.acc+"%",u.image.songName.style.fontSize=.868056*n+"px",u.image.songDiff.style.fontSize=.347222*n+"px",u.image.retryBtn.children[0].style.fontSize=.520833*n+"px",u.newScore.style.fontSize=.520833*n+"px",u.score.style.fontSize=1.736111*n+"px",u.judge.perfect.style.fontSize=.347222*n+"px",u.judge.good.style.fontSize=.347222*n+"px",u.judge.bad.style.fontSize=.347222*n+"px",u.judge.miss.style.fontSize=.347222*n+"px",u.acc.percent.style.fontSize=.347222*n+"px",u.acc.apType.style.fontSize=.520833*n+"px",u.acc.apType.visible=0<score.apType,u.image.image.anchor.set(.5),u.image.image.scale.set(c),u.image.image.position.x=s-a+a/2,u.image.image.position.y=o/2,u.image.gradient.filters||(u.image.gradient.filters=[new PIXI.filters.BlurFilter(14,4,PIXI.settings.FILTER_RESOLUTION,9)]),u.image.gradient.scale.set(1/c),u.image.gradient.position.y=u.image.image.texture.baseTexture.height/2,u.image.cover.position.set(s-a-l,l),u.image.image.mask=u.image.cover,u.image.songName.position.x=14.21875*n,u.image.songName.position.y=11.701389*n,u.image.songName.width>a-2*(14.21875*n-(s-a-l))&&(u.image.songName.width=a-2*(14.21875*n-(s-a-l))),u.image.songDiff.position.x=14.21875*n,u.image.songDiff.position.y=12.829861*n,u.image.retryBtn.position.x=s-3.802083*n-1.128472*n,u.image.retryBtn.position.y=o-1.336806*n-.711806*n,u.image.retryBtn.children[0].anchor.set(.5),u.image.retryBtn.children[0].position.x=3.802083*n/2,u.image.retryBtn.children[0].position.y=1.336806*n/2,u.judgeIcon.scale.set(4.930556*n/u.judgeIcon.texture.baseTexture.width),u.judgeIcon.position.x=.295139*n,u.judgeIcon.position.y=1.979167*n,u.newScore.position.x=r,u.newScore.position.y=8.211806*n,u.score.position.x=r,u.score.position.y=8.854167*n,u.judge.good.position.x=u.judge.perfect.width+.78125*n,u.judge.bad.position.x=u.judge.good.position.x+u.judge.good.width+.78125*n,u.judge.miss.position.x=u.judge.bad.position.x+u.judge.bad.width+.78125*n,u.judge.container.position.x=r,u.judge.container.position.y=11.041667*n,u.acc.percent.anchor.y=u.acc.apType.visible?1:0,u.acc.percent.position.x=u.acc.apType.visible?u.acc.apType.width+.416667*n:0,u.acc.percent.position.y=u.acc.apType.visible?u.acc.apType.height:.138889*n,u.acc.container.position.x=r,u.acc.container.position.y=u.judge.container.position.y+u.judge.container.height+1.163194*n,u.container.position.x=(t-u.container.width)/2,u.container.position.y=(i-u.container.height)/2,u}function CalculateChartActualTime(e){sprites.performanceIndicator&&sprites.performanceIndicator.begin();var t,n,s,o,i,r,a=(global.audio?_chart.audio.duration*global.audio.progress:0)-_chart.data.offset-_chart.audio.baseLatency-settings.chartDelay,l=pixi.renderer.fixedWidth,d=(pixi.renderer.realHeight,pixi.renderer.fixedWidthOffset),c=pixi.renderer.noteSpeed,u=pixi.renderer.noteScale;pixi.renderer.resolution;let h={};if(sprites.containers){sprites.progressBar.position.x=l*(global.audio?global.audio.progress:0)+d;for(var p of sprites.containers){let i=p.children[0];if(i){if(!settings.disableJudgeLineAlpha)for(var m of i.judgeLineDisappearEvents){if(a<m.startRealTime)break;a>m.endRealTime||(t=(a-m.startRealTime)/(m.endRealTime-m.startRealTime),i.alpha=m.start*(1-t)+m.end*t)}for(var g of i.judgeLineMoveEvents){if(a<g.startRealTime)break;a>g.endRealTime||(s=1-(n=(a-g.startRealTime)/(g.endRealTime-g.startRealTime)),p.position.x=l*(g.start*s+g.end*n)+d,p.position.y=pixi.renderer.realHeight*(1-g.start2*s-g.end2*n))}for(const T of i.judgeLineRotateEvents){if(a<T.startRealTime)break;a>T.endRealTime||(o=(a-T.startRealTime)/(T.endRealTime-T.startRealTime),p.rotation=T.startDeg*(1-o)+T.endDeg*o,p.cosr=Math.cos(p.rotation),p.sinr=Math.sin(p.rotation))}for(const b of i.speedEvents){if(a<b.startRealTime)break;if(!(a>b.endRealTime)){h[i.id]=(a-b.startRealTime)*b.value+b.floorPosition;for(let t=1;t<p.children.length;t++){let e=p.children[t];e.position.y=h[i.id]*c*e.noteDirection}}}}}for(var f of sprites.totalNotes)0<f.score&&f.isProcessed||(3==f.type&&f.offsetY<=h[f.lineId]&&(0<=(r=f.holdLength+f.offsetY-h[f.lineId])&&(f.children[1].height=r*c/u,f.children[2].position.y=-f.children[1].height,f.position.y=h[f.lineId]*c*(f.isAbove?-1:1))),1!=f.speed&&3!=f.type&&(f.position.y=(h[f.lineId]+(f.offsetY-h[f.lineId])*f.speed)*c*(f.isAbove?-1:1)),(i=f.realTime-a)<=0?3!=f.type?(r=f.realTime-a)>-global.judgeTimes.bad?f.alpha=(global.judgeTimes.bad+r)/global.judgeTimes.bad:(f.alpha=0,f.visible=!1):f.realTime+f.realHoldTime<=a&&(f.alpha=0,f.visible=!1,f.isProcessed=!0):0<f.parent.position.y+f.position.y*(f.isAbove?1:-1)&&1==f.visible?(3!=f.type&&i>global.judgeTimes.bad||i+f.realHoldTime>global.judgeTimes.bad)&&(f.visible=!1):f.parent.position.y+f.position.y*(f.isAbove?1:-1)<=0&&0==f.visible&&(3!=f.type&&i>global.judgeTimes.bad||i+f.realHoldTime>global.judgeTimes.bad)&&(f.visible=!0));for(var x in judgements.addJudgement(sprites.totalNotes,a),judgements.judgeNote(sprites.totalNotes,a,.117775*l),inputs.taps.length=0,inputs.touches)inputs.touches[x]instanceof Click&&inputs.touches[x].animate();for(var v in inputs.mouse)inputs.mouse[v]instanceof Click&&inputs.mouse[v].animate();global.audio&&1==global.audio.progress&&(pixi.ticker.remove(CalculateChartActualTime),sprites.headInfos.position.y=-sprites.headInfos.height,sprites.footInfos.position.y=sprites.headInfos.height,sprites.ui.end=CreateGameEndAnimate(sprites.ui.end)),sprites.performanceIndicator&&sprites.performanceIndicator.end()}}function CalculateClickAnimateActualTime(){for(var e in sprites.clickAnimate){let i=sprites.clickAnimate[e];if(2<i.type){i=i.children[0];var n=i.currentFrame/i.totalFrames;for(let t=1;t<i.parent.children.length;t++){let e=i.parent.children[t];var s=30*(((.2078*n-1.6524)*n+1.6399)*n+.4988),o=e.distance*(9*n/(8*n+1))*.6;e.clear(),e.beginFill(16777215).drawRect(-s/2,-s/2,s,s).endFill(),e.position.x=o*e.cosr-o*e.sinr,e.position.y=o*e.cosr+o*e.sinr,e.alpha=1-n}i.playing||(sprites.clickAnimate.splice(e,1),i.parent.destroy())}else i.alpha-=2/pixi.ticker.FPS,i.alpha<=0&&(i.destroy(),sprites.clickAnimate.splice(e,1))}}function CreateClickAnimation(e,i=!1){let n=void 0;pixi.renderer.fixedWidth;var s=pixi.renderer.noteScale;let o=e.score,r=getNotePosition(e).x,a=getNotePosition(e).y,t=e.parent.parent.angle;if(pixi&&settings.clickAnimate&&!(o<=1)){if(2<o){let e=new PIXI.AnimatedSprite(textures.clickRaw);var l=14.964;let t=[null,null,null,null];if(n=new PIXI.Container,e.tint=4==o?16772256:11854335,e.anchor.set(.5),e.scale.set(256/e.texture.baseTexture.width),e.loop=!1,n.addChild(e),!i)for(let e=0;e<t.length;e++)t[e]=(new PIXI.Graphics).beginFill(16777215).drawRect(-l/2,-l/2,l,l).endFill(),t[e].tint=4==o?16772256:11854335,t[e].distance=81*Math.random()+185,t[e].direction=Math.floor(360*Math.random()),t[e].sinr=Math.sin(t[e].direction),t[e].cosr=Math.cos(t[e].direction),n.addChild(t[e]);n.scale.set(5.6*s),n.position.set(r,a)}else r=getNotePosition(e,!1).x,a=getNotePosition(e,!1).y,n=new PIXI.Sprite(textures.tap2),n.anchor.set(.5),n.scale.set(s),n.position.set(r,a),n.angle=t,n.tint=7095107;n.type=o,sprites.clickAnimate.push(n),pixi.stage.addChild(n),3!=o&&4!=o||n.children[0].play()}}function ResizeChartSprites(e,t,i,n=8e3){var s,o,r=t<=i/9*16?t:i/9*16,a=(t-r)/2,l=.75*i<r?i/18.75:r/14.0625,d=r/n,c=.6*i;if(e.background&&(s=r/_chart.image.width,o=pixi.renderer.realHeight/_chart.image.height,e.background.scale.set(o<s?s:o),e.background.position.set(t/2,i/2)),e.containers&&e.totalNotes&&!(e.containers.length<=0||e.totalNotes.length<=0)){for(var u of e.containers){let e=u.children[0];e.height=18.75*l*.008,e.width=e.height*e.texture.width/e.texture.height*1.042}for(var h of e.totalNotes)3==h.type&&3==h.children.length&&(h.children[1].height=h.holdLength*c/d,h.children[2].position.y=-h.children[1].height),h.scale.set(d),h.position.x=.109*h.positionX.toFixed(6)*(r/2),h.position.y=h.offsetY*c*(h.isAbove?-1:1);e.progressBar&&e.progressBar.scale.set(r/(1920/pixi.renderer.resolution)),e.comboText&&(e.comboText.children[0].style.fontSize=1.32*l+"px",e.comboText.children[1].style.fontSize=.66*l+"px",e.comboText.position.x=t/2,e.comboText.children[0].position.y=1.375*l,e.comboText.children[1].position.y=1.375*l+e.comboText.children[0].height),e.scoreText&&(e.scoreText.style.fontSize=.95*l+"px",e.scoreText.position.set(t-.65*l-a,1.375*l)),e.songTitleBig&&(e.songTitleBig.style.fontSize=1.1*l+"px",e.songTitleBig.position.x=t/2,e.songTitleBig.position.y=i/2*.75),e.bgAuthorBig&&(e.bgAuthorBig.style.fontSize=.55*l+"px",e.bgAuthorBig.position.x=t/2,e.bgAuthorBig.position.y=i/2*1.25+.15*l),e.chartAuthorBig&&(e.chartAuthorBig.style.fontSize=.55*l+"px",e.chartAuthorBig.position.x=t/2,e.chartAuthorBig.position.y=i/2*1.25+l),e.songNameBar&&(e.songNameBar.width=.119*l,e.songNameBar.height=.612*l,e.songNameBar.position.x=.53*l+a,e.songNameBar.position.y=i-1.22*l),e.songTitle&&(e.songTitle.style.fontSize=.63*l+"px",e.songTitle.position.x=.85*l+a,e.songTitle.position.y=i-.52*l),e.songDiff&&(e.songDiff.style.fontSize=.63*l+"px",e.songDiff.position.x=t-.75*l-a,e.songDiff.position.y=i-.52*l),e.backgroundCover&&(s=t/_chart.image.width,o=i/_chart.image.height,e.backgroundCover.image.scale.set(o<s?s:o),e.backgroundCover.image.position.set(t/2,i/2),e.backgroundCover.image.alpha=t!=r?1:0,e.gameEnd||(e.backgroundCover.cover.children[0].clear(),e.backgroundCover.cover.children[0].beginFill(16777215).drawRect(0,0,a,i).endFill(),e.backgroundCover.cover.children[1].clear(),e.backgroundCover.cover.children[1].beginFill(16777215).drawRect(t-a,0,a,i).endFill())),e.fps&&(e.fps.style.fontSize=.8*l+"px",e.fps.position.set(t-1,1)),e.watermark&&(e.watermark.style.fontSize=.6*l+"px",e.watermark.position.set(t-2,i-2)),e.accIndicator&&(e.accIndicator.container.position.x=t/2,e.accIndicator.container.scale.set(t/e.accIndicator.scale)),e.ui.end&&CreateGameEndAnimate(e.ui.end)}}function CreateAccurateIndicator(e,t=500,i=!1){let o=new PIXI.Container,n=new PIXI.Graphics;return n.beginFill(16777215,.4),n.drawRect(0,2,i?100:200,16),n.endFill(),n.beginFill(9306112,.8),n.drawRect(0,6,i?10:20,8),n.endFill(),n.beginFill(11854335,.8),n.drawRect(i?10:20,6,i?20:40,8),n.endFill(),n.beginFill(16772256,.8),n.drawRect(i?30:60,6,i?40:80,8),n.endFill(),n.beginFill(11854335,.8),n.drawRect(i?70:140,6,i?20:40,8),n.endFill(),n.beginFill(9306112,.8),n.drawRect(i?90:180,6,i?10:20,8),n.endFill(),n.beginFill(16777215,.8),n.drawRect(i?49:99,0,2,20),n.endFill(),o.addChild(n),n.position.x=-n.width/2,o.scale.set(e.renderer.realWidth/t),o.position.x=e.renderer.realWidth/2,e.stage.addChild(o),e.ticker.add(()=>{if(1<o.children.length)for(let t=1,e=o.children.length;t<e;t++){let e=o.children[t];e&&(e.alpha-=.5/60,e.alpha<=0&&e.destroy())}}),{container:o,scale:t,pushAccurate:function(e,t){new PIXI.Container;let i=new PIXI.Graphics,n=t-e,s=0<n?n:-n;s<global.judgeTimes.perfect?s=16772256:s<global.judgeTimes.good?s=11854335:s<global.judgeTimes.bad&&(s=9306112);return i.beginFill(s),i.drawRect(0,0,2,20),i.endFill(),i.position.x=1e3*n/2,o.addChild(i),i}}}function DrawInputPoint(e,t,i,n,s=0){let o=sprites.inputs[i],r=o?o[n]:null;if(settings.showFinger)return r?r.visible||(r.scale.set(.08*pixi.renderer.lineScale),r.visible=!0):(r=new PIXI.Graphics,r.beginFill(16777215),r.drawCircle(0,0,6),r.endFill(),r.scale.set(.08*pixi.renderer.lineScale),pixi.stage.addChild(r),o[n]=r,sprites.inputs[i]=o),r.position.set(e,t),0==s?r.tint=65535:1==s?r.tint=16776960:2==s&&(r.tint=16711935),r}function getNotePosition(e,t=!0){var i=e.parent.parent.cosr,n=e.parent.parent.sinr,s=e.parent.parent.position.x,o=e.parent.parent.position.y,r=s+e.position.x,e=o+(t?0:e.parent.position.y+e.position.y);return{x:(r-s)*i-(e-o)*n+s,y:(e-o)*i+(r-s)*n+o}}const tween=[null,null,e=>Math.sin(e*Math.PI/2),e=>1-Math.cos(e*Math.PI/2),e=>1-(e-1)**2,e=>e**2,e=>(1-Math.cos(e*Math.PI))/2,e=>((e*=2)<1?e**2:-((e-2)**2-2))/2,e=>1+(e-1)**3,e=>e**3,e=>1-(e-1)**4,e=>e**4,e=>((e*=2)<1?e**3:(e-2)**3+2)/2,e=>((e*=2)<1?e**4:-((e-2)**4-2))/2,e=>1+(e-1)**5,e=>e**5,e=>1-2**(-10*e),e=>2**(10*(e-1)),e=>Math.sqrt(1-(e-1)**2),e=>1-Math.sqrt(1-e**2),e=>(2.70158*e-1)*(e-1)**2+1,e=>(2.70158*e-1.70158)*e**2,e=>((e*=2)<1?1-Math.sqrt(1-e**2):Math.sqrt(1-(e-2)**2)+1)/2,e=>e<.5?(14.379638*e-5.189819)*e**2:(14.379638*e-9.189819)*(e-1)**2+1,e=>1-2**(-10*e)*Math.cos(e*Math.PI/.15),e=>2**(10*(e-1))*Math.cos((e-1)*Math.PI/.15),e=>((e*=11)<4?e**2:e<8?(e-6)**2+12:e<10?(e-9)**2+15:(e-10.5)**2+15.75)/16,e=>1-tween[26](1-e),e=>(e*=2)<1?tween[26](e)/2:tween[27](e-1)/2+.5,e=>e<.5?2**(20*e-11)*Math.sin((160*e+1)*Math.PI/18):1-2**(9-20*e)*Math.sin((160*e+1)*Math.PI/18)];function ConvertPEC2Json(e,t){class i{numOfNotes=0;numOfNotesAbove=0;numOfNotesBelow=0;bpm=120;constructor(e){this.bpm=e,"speedEvents,notesAbove,notesBelow,judgeLineDisappearEvents,judgeLineMoveEvents,judgeLineRotateEvents,judgeLineDisappearEventsPec,judgeLineMoveEventsPec,judgeLineRotateEventsPec".split(",").map(e=>this[e]=[])}pushNote(e,t,i){switch(t){case void 0:case 1:this.notesAbove.push(e);break;case 2:this.notesBelow.push(e);break;default:throw"Note 参数错误：错误的 Note 位置："+t}i||(this.numOfNotes++,this.numOfNotesAbove++)}pushEvent(e,t,i,n,s,o,r){const a={startTime:t,endTime:i};switch("number"==typeof t&&"number"==typeof i&&i<t&&console.warn("判定线事件错误：事件起始时间（"+t+"）大于结束时间（"+i+"）"),e){case 0:a.value=n,this.speedEvents.push(a);break;case 1:a.start=n,a.end=s,a.start2=0,a.end2=0,this.judgeLineDisappearEvents.push(a);break;case 2:a.start=n,a.end=s,a.start2=o,a.end2=r,this.judgeLineMoveEvents.push(a);break;case 3:a.start=n,a.end=s,a.start2=0,a.end2=0,this.judgeLineRotateEvents.push(a);break;case-1:a.value=n,a.motionType=1,this.judgeLineDisappearEventsPec.push(a);break;case-2:a.value=n,a.value2=s,a.motionType=o,this.judgeLineMoveEventsPec.push(a);break;case-3:a.value=n,a.motionType=s,this.judgeLineRotateEventsPec.push(a);break;default:throw"判定线事件错误：无效的事件类型："+e}}}class n{constructor(e,t,i,n,s){this.type=e,this.time=t,this.positionX=i,this.holdTime=3==e?n:0,this.speed=isNaN(s)?1:s}}let s=e.match(/[^\n\r ]+/g).map(e=>(isNaN(e)?String:Number)(e)),r=new class{constructor(){this.formatVersion=3,this.offset=0,this.numOfNotes=0,this.judgeLineList=[]}pushLine(e){return this.judgeLineList.push(e),this.numOfNotes+=e.numOfNotes,e}},o={},a=[],l="",d=[1,1],c,u=[],h=[];isNaN(s[0])||(r.offset=s.shift()/1e3-.175),"bp,n1,n2,n3,n4,cv,cp,cd,ca,cm,cr,cf".split(",").map(e=>o[e]=[]);for(let e=0;e<s.length;e++){var p=s[e];if(isNaN(p))if("#"==p&&"n"==l[0])d[0]=s[++e];else if("&"==p&&"n"==l[0])d[1]=s[++e];else{if(!o[p])throw"谱面参数错误：未知的指令："+p;J(p)}else a.push(p)}J(""),o.bp[0]||o.bp.push([0,120]),c=o.bp[0][1],o.bp[0][0]&&o.bp.unshift([0,c]);let m=0;o.bp.sort((e,t)=>e[0]-t[0]).forEach((e,t,i)=>{var n;i[t+1]&&i[t+1][0]<=0||(n=e[0]<0?0:e[0],t=i[t+1]?i[t+1][0]:1e9,e=e[1],u.push({startTime:n,endTime:t,bpm:e,value:m}),m+=(t-n)/e)});for(var g of o.n1)h[g[0]]||(h[g[0]]=new i(c)),h[g[0]].pushNote(new n(1,_(g[1])+(g[4]?1e9:0),9*g[2]/1024,0,g[5]),g[3],g[4]),g[4]&&console.warn('检测到 FakeNote，该 Note 可能会产生显示异常。\n位于："n1 '+g.slice(0,5).join(" ")+'"\n来自 '+t),1!=g[6]&&console.warn('检测到异常 Note，该 Note 可能会产生显示异常。\n位于："n1 '+g.slice(0,5).join(" ")+" # "+g[5]+" & "+g[6]+'"\n来自 '+t);for(var f of o.n4)h[f[0]]||(h[f[0]]=new i(c)),h[f[0]].pushNote(new n(2,_(f[1])+(f[4]?1e9:0),9*f[2]/1024,0,f[5]),f[3],f[4]),f[4]&&console.warn('检测到 FakeNote，该 Note 可能会产生显示异常。\n位于："n1 '+f.slice(0,5).join(" ")+'"\n来自 '+t),1!=f[6]&&console.warn('检测到异常 Note，该 Note 可能会产生显示异常。\n位于："n1 '+f.slice(0,5).join(" ")+" # "+f[5]+" & "+f[6]+'"\n来自 '+t);for(var x of o.n2)h[x[0]]||(h[x[0]]=new i(c)),h[x[0]].pushNote(new n(3,_(x[1])+(x[5]?1e9:0),9*x[3]/1024,_(x[2])-_(x[1]),x[6]),x[4],x[5]),x[5]&&console.warn('检测到 FakeNote，该 Note 可能会产生显示异常。\n位于："n2 '+x.slice(0,6).join(" ")+'"\n来自 '+t),1!=x[7]&&message.sendWarning('检测到异常 Note，该 Note 可能会产生显示异常。\n位于:"n2 '+x.slice(0,5).join(" ")+" # "+x[6]+" & "+x[7]+'"\n来自 '+t);for(var v of o.n3)h[v[0]]||(h[v[0]]=new i(c)),h[v[0]].pushNote(new n(4,_(v[1])+(v[4]?1e9:0),9*v[2]/1024,0,v[5]),v[3],v[4]),v[4]&&console.warn('检测到 FakeNote，该 Note 可能会产生显示异常。\n位于："n1 '+v.slice(0,5).join(" ")+'"\n来自 '+t),1!=v[6]&&console.warn('检测到异常 Note，该 Note 可能会产生显示异常。\n位于："n1 '+v.slice(0,5).join(" ")+" # "+v[5]+" & "+v[6]+'"\n来自 '+t);for(var T of o.cv)h[T[0]]||(h[T[0]]=new i(c)),h[T[0]].pushEvent(0,_(T[1]),null,T[2]/7);for(var b of o.ca)h[b[0]]||(h[b[0]]=new i(c)),h[b[0]].pushEvent(-1,_(b[1]),_(b[1]),0<b[2]?b[2]/255:0),b[2]<0&&console.warn("检测到负数 Alpha:"+b[2]+'，该值将会被转换为 0。\n位于："ca '+b.join(" ")+'"\n来自 '+t);for(var I of o.cf)h[I[0]]||(h[I[0]]=new i(c)),I[1]>I[2]?console.warn('检测到事件时间轴不正确，该事件将被禁用。\n位于："cf '+I.join(" ")+'"\n来自 '+t):(h[I[0]].pushEvent(-1,_(I[1]),_(I[2]),0<I[3]?I[3]/255:0),I[3]<0&&console.warn("检测到负数 Alpha:"+I[3]+'，该值将会被转换为 0。\n位于："cf '+I.join(" ")+'"\n来自 '+t));for(var w of o.cp)h[w[0]]||(h[w[0]]=new i(c)),h[w[0]].pushEvent(-2,_(w[1]),_(w[1]),w[2]/2048,w[3]/1400,1);for(var y of o.cm)h[y[0]]||(h[y[0]]=new i(c)),y[1]>y[2]?console.warn('检测到事件时间轴不正确，该事件将被禁用。\n位于："cm '+y.join(" ")+'"\n来自 '+t):(h[y[0]].pushEvent(-2,_(y[1]),_(y[2]),y[3]/2048,y[4]/1400,y[5]),y[5]&&!tween[y[5]]&&1!=y[5]&&console.warn("检测到未知的移动类型："+y[5]+'，该值将会被转换为 1。\n位于："cm '+y.join(" ")+'"\n来自 '+t));for(var C of o.cd)h[C[0]]||(h[C[0]]=new i(c)),h[C[0]].pushEvent(-3,_(C[1]),_(C[1]),-C[2],1);for(var P of o.cr)h[P[0]]||(h[P[0]]=new i(c)),P[1]>P[2]?console.warn('检测到事件时间轴不正确，该事件将被禁用。\n位于："cr '+P.join(" ")+'"\n来自 '+t):(h[P[0]].pushEvent(-3,_(P[1]),_(P[2]),-P[3],P[4]),P[4]&&!tween[P[4]]&&1!=P[4]&&console.warn("检测到未知的旋转类型："+P[4]+'，该值将会被转换为 1。\n位于："cr '+P.join(" ")+'"\n来自 '+t));for(var j of h)if(j){var N=(e,t)=>e.startTime-t.startTime+(e.endTime-t.endTime);let i=j.speedEvents,n=j.judgeLineMoveEventsPec,s=j.judgeLineRotateEventsPec,o=j.judgeLineDisappearEventsPec;if(!(j.notesAbove.length<=0&&j.notesBelow.length<=0&&i.length<=1&&n.length<=1&&s.length<=1&&o.length<=1)){j.notesAbove.sort((e,t)=>e.time-t.time),j.notesBelow.sort((e,t)=>e.time-t.time),i.sort(N),n.sort(N),s.sort(N),o.sort(N);{let t=0;for(let e=0;e<i.length;e++)i[e].endTime=e<i.length-1?i[e+1].startTime:1e9,i[e].startTime<e&&(i[e].startTime=0),i[e].floorPosition=t,t+=(i[e].endTime-i[e].startTime)*i[e].value/j.bpm*1.875}for(var E of j.notesAbove){let e=0,t=0,i=0;for(var k of j.speedEvents)if(!(E.time%1e9>k.endTime)){if(E.time%1e9<k.startTime)break;e=k.value,t=k.floorPosition,i=E.time%1e9-k.startTime}E.floorPosition+=t+e*i/j.bpm*1.875,3==E.type&&(E.speed*=e)}for(var B of j.notesBelow){let e=0,t=0,i=0;for(var S of j.speedEvents)if(!(B.time%1e9>S.endTime)){if(B.time%1e9<S.startTime)break;e=S.value,t=S.floorPosition,i=B.time%1e9-S.startTime}B.floorPosition+=t+e*i/j.bpm*1.875,3==B.type&&(B.speed*=e)}{let e=0,t=0;for(var M of o){if(j.pushEvent(1,e,M.startTime,t,t),tween[M.motionType])for(let e=parseInt(M.startTime);e<parseInt(M.endTime);e++){var F=(e-M.startTime)/(M.endTime-M.startTime),A=(e+1-M.startTime)/(M.endTime-M.startTime),L=M.value-t;j.pushEvent(1,e,e+1,t+tween[M.motionType](F)*L,t+tween[M.motionType](A)*L)}else M.motionType&&j.pushEvent(1,M.startTime,M.endTime,t,M.value);e=M.endTime,t=M.value}j.pushEvent(1,e,1e9,t,t)}{let e=0,t=0,i=0;for(const Y of n){if(j.pushEvent(2,e,Y.startTime,t,t,i,i),tween[Y.motionType])for(let e=parseInt(Y.startTime);e<parseInt(Y.endTime);e++){var R=(e-Y.startTime)/(Y.endTime-Y.startTime),D=(e+1-Y.startTime)/(Y.endTime-Y.startTime),X=Y.value-t,H=Y.value2-i;j.pushEvent(2,e,e+1,t+tween[Y.motionType](R)*X,t+tween[Y.motionType](D)*X,i+tween[Y.motionType](R)*H,i+tween[Y.motionType](D)*H)}else Y.motionType&&j.pushEvent(2,Y.startTime,Y.endTime,t,Y.value,i,Y.value2);e=Y.endTime,t=Y.value,i=Y.value2}j.pushEvent(2,e,1e9,t,t,i,i)}{let e=0,t=0;for(const G of s){if(j.pushEvent(3,e,G.startTime,t,t),tween[G.motionType])for(let e=parseInt(G.startTime);e<parseInt(G.endTime);e++){var z=(e-G.startTime)/(G.endTime-G.startTime),O=(e+1-G.startTime)/(G.endTime-G.startTime),W=G.value-t;j.pushEvent(3,e,e+1,t+tween[G.motionType](z)*W,t+tween[G.motionType](O)*W)}else G.motionType&&j.pushEvent(3,G.startTime,G.endTime,t,G.value);e=G.endTime,t=G.value}j.pushEvent(3,e,1e9,t,t),r.pushLine(j)}}}return JSON.parse(JSON.stringify(r));function J(e){o[l]&&("n"==l[0]&&(a.push(...d),d=[1,1]),o[l].push(JSON.parse(JSON.stringify(a)))),a.length=0,l=e}function _(e){let t=0;for(const i of u){if(e<i.startTime)break;e>i.endTime||(t=Math.round(((e-i.startTime)/i.bpm+i.value)*c*32))}return t}}function ConvertChartVersion(e){let t=JSON.parse(JSON.stringify(e));switch(t.formatVersion){case 1:t.formatVersion=3;for(const i of t.judgeLineList){let e=0;for(const n of i.speedEvents)n.startTime<0&&(n.startTime=0),n.floorPosition=e,e+=(n.endTime-n.startTime)*n.value/i.bpm*1.875;for(const s of i.judgeLineDisappearEvents)s.start2=0,s.end2=0;for(const o of i.judgeLineMoveEvents)o.start2=o.start%1e3/520,o.end2=o.end%1e3/520,o.start=parseInt(o.start/1e3)/880,o.end=parseInt(o.end/1e3)/880;for(const r of i.judgeLineRotateEvents)r.start2=0,r.end2=0}case 3:case 3473:break;default:throw"谱面数据错误：未知的谱面格式版本："+t.formatVersion}return t}function Csv2Array(e,t){const n=[];for(const s of e.replace(/\r/g,"").split("\n")){let e="",t=!1,i=!1;const o=[];for(const r of s)if('"'==r)t?i=!i||(e+=r,!1):t=!0;else if(","==r)t?i?(o.push(e),e="",t=!1,i=!1):e+=r:(o.push(e),e="");else{if(i)throw"Error 1";e+=r}if(t){if(!i)throw"Error 2";o.push(e),e="",t=!1,i=!1}else o.push(e),e="";n.push(o)}if(!t)return n;const i=[];for(let t=1;t<n.length;t++){const a={};for(let e=0;e<n[0].length;e++)a[n[0][e]]=n[t][e];i.push(a)}return i}var panelInst=new mdui.Panel("#panel"),drawerInst=new mdui.Drawer("#drawer"),pixi=null,Loader=new PIXI.Loader,sprites={},textures={judgeIcon:{},sound:{}},_chart={},chartData={images:void 0,imagesBlur:void 0,audios:void 0,charts:void 0,infos:void 0,lines:void 0},inputs={taps:[],touches:{},mouse:{},isMouseDown:{},keyboard:{}},stat={isRetrying:!1,isTransitionEnd:!1,isPaused:!1,isFullscreen:!1},judgements=new Judgements;const judgementTimes={bad:200,good:160,perfect:80,badChallenge:100,goodChallenge:75,perfectChallenge:40};Loader.onProgress.add(function(e,t){e.progress.toFixed(0)<100?setProgress("loading-sources","正在加载资源："+t.url+"...",e.progress/100):(setProgress("loading-sources","全部资源加载完毕！",1),setTimeout(()=>{panelInst.closeAll(),panelInst.open(1)},500))});{let t=document.getElementById("drawer").getElementsByClassName("mdui-list-item");for(let e of t)e.addEventListener("click",e=>{!drawerInst.isDesktop()&&drawerInst.isOpen()&&drawerInst.close()})}function selectZip(){let e=document.getElementById("input-select-chart"),t=document.getElementById("button-select-chart-zip");e.click(),e.onchange=function(){this.files&&1==this.files.length&&(t.innerHTML="当前文件："+this.files[0].name,decodeZip(this))}}function decodeZip(t){let i=new FileReader,n=new JSZip;if(i.onprogress=e=>{e.loaded<t.files[0].size?setProgress("loading-chart-zip","正在读取谱面包...",e.loaded/t.files[0].size):setProgress("loading-chart-zip","谱面包读取完成！",1)},i.onloadend=e=>{n.loadAsync(i.result).then(e=>async function(i){const t="jpeg,jpg,gif,png,webp".split(","),n="aac,flac,mp3,ogg,wav,webm".split(",");let s=0,o=[];for(var e in chartData)chartData[e]={};for(var r in i.files){let e=i.files[r],t=r.split("/");r="";t=t[t.length-1],r=m(t),e.dir||(e.realName=t,e.format=r,e.isHidden=0==t.indexOf("."),o.push(e))}for(var a of o){let e=a.format;if(setProgress("loading-decode-chart","正在解析文件："+a.name+"...",s/o.length),"info.csv"==a.name){var l=Csv2Array(await a.async("text"),!0);chartData.infos=JSON.parse(JSON.stringify(l))}else if("line.csv"==a.name){l=Csv2Array(await a.async("text"),!0);chartData.lines=l}else if(-1!==t.indexOf(e.toLowerCase()))try{var d=await PIXI.Texture.fromURL("data:image/"+e+";base64,"+await a.async("base64")),c=PIXI.Texture.from(BlurImage(d.baseTexture,20));chartData.images[a.name]=d,chartData.imagesBlur[a.name]=c}catch(i){console.warn('"'+a.name+'" 可能不是一个有效的图像文件，将不会加载该文件。',i)}else if(-1!==n.indexOf(e.toLowerCase()))try{var u=PIXI.sound.Sound.from({source:await a.async("arraybuffer"),preload:!0});chartData.audios[a.name]=u}catch(i){console.warn('"'+a.name+'" 可能不是一个有效的音频文件，将不会加载该文件。',i)}else if("json"===e)try{var h=await a.async("text");h=await CalculateChartData(h=await ConvertChartVersion(JSON.parse(h))),chartData.charts[a.name]=h}catch(i){console.warn('"'+a.name+'" 可能不是一个有效的谱面文件，将不会加载该文件。',i)}else if("pec"===e)try{var p;p=await CalculateChartData(p=await ConvertChartVersion(await ConvertPEC2Json(p=await a.async("text"),a.name))),chartData.charts[a.name]=p}catch(i){console.warn('"'+a.name+'" 可能不是一个有效的谱面文件，将不会加载该文件。',i)}else console.warn('"'+a.name+'" 是一个不支持的文件，将不会加载该文件。');s++}createMenuItems("menu-chart-file",chartData.charts,"_chart.data","chartData.charts",null,-1,"switchChart(this.getAttribute('menu-value'))","list-text-chart-file"),createMenuItems("menu-chart-audio",chartData.audios,"_chart.audio","chartData.audios",null,null,null,"list-text-chart-audio"),createMenuItems("menu-chart-image",chartData.images,"_chart.image","chartData.images",null,null,"_chart.imageBlur = chartData.imagesBlur[this.getAttribute('menu-value')]","list-text-chart-image");{let e=document.getElementById("menu-chart-file").getElementsByTagName("a");switchChart(e[e.length-1].getAttribute("menu-value"))}setProgress("loading-decode-chart","全部文件解析完毕！",1),setTimeout(()=>{panelInst.closeAll(),panelInst.open(2)},500)}(e)).catch(e=>{console.error('"'+t.files[0].name+'" 可能不是一个有效的 zip 文件。',e)})},"zip"!=m(t.files[0].name))return mdui.alert("这不是一个 *.zip 后缀的文件！<br>请确认您选择的是正确的文件格式。","前方高能"),!1;function m(e){e=e.split(".");return e[e.length-1]}i.readAsArrayBuffer(t.files[0]),mdui.$("#loading-chart-group").removeClass("mdui-hidden")}function switchChart(s){var o=chartData.infos;if(o){let n={};try{for(var e of o){var t,i=JSON.parse(JSON.stringify(e)),r=document.getElementById("menu-chart-audio").getElementsByTagName("a"),a=document.getElementById("menu-chart-image").getElementsByTagName("a");for(t in i)if(0<=t.indexOf("Chart")&&i[t]==s){if(n={info:{name:i.Name,level:i.Level,illustrator:i.Illustrator,designer:i.Designer},data:chartData.charts[s],audio:chartData.audios[i.Music],image:chartData.images[i.Image],imageBlur:chartData.imagesBlur[i.Image],lines:[]},chartData.lines instanceof Array)for(var l of chartData.lines)l.Chart==i.Chart&&n.lines.push(l);for(var d of r)if(d.getAttribute("menu-value")==i.Music){selectMenuItem("menu-chart-audio",d,"list-text-chart-audio");break}for(var c of a)if(c.getAttribute("menu-value")==i.Image){selectMenuItem("menu-chart-image",c,"list-text-chart-image");break}return mdui.$("#input-chart-name").val(i.Name),mdui.$("#input-chart-difficulty").val(i.Level),mdui.$("#input-chart-author").val(i.Designer),mdui.$("#input-chart-bg-author").val(i.Illustrator),mdui.mutation("#panel-select-chart-info"),void(_chart=n)}}}catch(e){console.warn("该谱面包可能不自带谱面信息，您可能需要手动填写相关信息。",e);let t=document.getElementById("menu-chart-image").getElementsByTagName("a")[0],i=document.getElementById("menu-chart-audio").getElementsByTagName("a")[0];var u=t.getAttribute("menu-value"),o=i.getAttribute("menu-value");if(n={info:{name:null,level:null,illustrator:null,designer:null},data:chartData.charts[s],audio:chartData.audios[o],image:chartData.images[u],imageBlur:chartData.imagesBlur[u],lines:[]},chartData.lines instanceof Array)for(var h of chartData.lines)h.Chart==s&&n.lines.push(h);return selectMenuItem("menu-chart-audio",i,"list-text-chart-audio"),selectMenuItem("menu-chart-image",t,"list-text-chart-image"),void(_chart=n)}}}function switchPanel(e){panelInst.closeAll(),panelInst.open(e)}function openMenu(e,t){let i=document.getElementById(t),n=new mdui.Menu(e,i,{align:"right"});i.style.width=(320<e.clientWidth-72?320:e.clientWidth-72)+"px",n.toggle()}function gameInit(){let t=document.getElementById("game-canvas-box");if(_chart.data)if(_chart.audio&&_chart.audio.isLoaded)if(pixi)mdui.alert("模拟器已经启动啦！","前方高能",()=>{switchPanel(6)});else{global.judgeTimes={perfect:(settings.challengeMode?judgementTimes.perfectChallenge:judgementTimes.perfect)/1e3,good:(settings.challengeMode?judgementTimes.goodChallenge:judgementTimes.good)/1e3,bad:(settings.challengeMode?judgementTimes.badChallenge:judgementTimes.bad)/1e3},switchPanel(6),pixi=new PIXI.Application({width:t.offsetWidth,height:t.offsetWidth*(1/settings.windowRatio),antialias:settings.antiAlias,autoDensity:!0,resolution:settings.resolution,forceCanvas:settings.forceCanvas}),t.innerHTML="",t.appendChild(pixi.view),pixi.renderer.realWidth=pixi.renderer.width/pixi.renderer.resolution,pixi.renderer.realHeight=pixi.renderer.height/pixi.renderer.resolution,pixi.renderer.fixedWidth=pixi.renderer.realWidth<=pixi.renderer.realHeight/9*16?pixi.renderer.realWidth:pixi.renderer.realHeight/9*16,pixi.renderer.fixedWidthOffset=(pixi.renderer.realWidth-pixi.renderer.fixedWidth)/2,pixi.renderer.noteSpeed=.6*pixi.renderer.realHeight,pixi.renderer.noteScale=pixi.renderer.fixedWidth/settings.noteScale,pixi.renderer.lineScale=pixi.renderer.fixedWidth>.75*pixi.renderer.realHeight?pixi.renderer.realHeight/18.75:pixi.renderer.fixedWidth/14.0625;let e=!1;try{pixi.view.addEventListener("test",null,Object.defineProperty({},"passive",{get:function(){e={passive:!1}}}))}catch(e){}if(window.addEventListener("resize",()=>{global.functions.resizeCanvas(pixi)}),pixi.view.addEventListener("touchstart",e=>{e.preventDefault();for(var t of e.changedTouches){var i=t.identifier,t=n(t);inputs.touches[i]=Click.activate(t.x,t.y,"touches",i)}},e),pixi.view.addEventListener("touchmove",e=>{e.preventDefault();for(var t of e.changedTouches){var i=t.identifier,t=n(t);inputs.touches[i].move(t.x,t.y)}},e),pixi.view.addEventListener("touchend",e=>{e.preventDefault();for(var t of e.changedTouches){t=t.identifier;delete inputs.touches[t],settings.showFinger&&sprites.inputs.touches[t]&&(sprites.inputs.touches[t].visible=!1)}},e),pixi.view.addEventListener("touchcancel",e=>{e.preventDefault();for(var t of e.changedTouches){t=t.identifier;delete inputs.touches[t],settings.showFinger&&sprites.inputs.touches[t]&&(sprites.inputs.touches[t].visible=!1)}},e),pixi.view.addEventListener("mousedown",e=>{e.preventDefault();var t=e.button,e=n(e);inputs.mouse[t]=Click.activate(e.x,e.y,"mouse",t),inputs.isMouseDown[t]=!0},e),pixi.view.addEventListener("mousemove",e=>{for(var t in e.preventDefault(),inputs.isMouseDown){var i;inputs.isMouseDown[t]&&(i=n(e),inputs.mouse[t].move(i.x,i.y))}},e),pixi.view.addEventListener("mouseup",e=>{e.preventDefault();e=e.button;delete inputs.mouse[e],delete inputs.isMouseDown[e],settings.showFinger&&sprites.inputs.mouse[e]&&(sprites.inputs.mouse[e].visible=!1)},e),pixi.view.addEventListener("mouseout",e=>{for(var t in e.preventDefault(),inputs.mouse)inputs.isMouseDown[t]&&(delete inputs.mouse[t],delete inputs.isMouseDown[t],settings.showFinger&&sprites.inputs.mouse[t]&&(sprites.inputs.mouse[t].visible=!1))},e),CreateChartInfoSprites(sprites=CreateChartSprites(_chart.data,pixi),pixi,!0),sprites.ui={},settings.accIndicator&&(sprites.accIndicator=CreateAccurateIndicator(pixi,settings.accIndicatorScale,settings.challengeMode)),score.init(sprites.totalNotes.length,settings.challengeMode),settings.showJudgementRealTime){let e={container:new PIXI.Container,judge:new PIXI.Text("Judge: False",{fill:"white",fontSize:8}),acc:new PIXI.Text("Acc: 0%",{fill:"white",fontSize:8}),perfect:new PIXI.Text("Perfect: 0",{fill:"white",fontSize:8}),good:new PIXI.Text("Good: 0",{fill:"white",fontSize:8}),bad:new PIXI.Text("Bad: 0",{fill:"white",fontSize:8}),miss:new PIXI.Text("Miss: 0",{fill:"white",fontSize:8})};e.container.addChild(e.judge,e.acc,e.perfect,e.good,e.bad,e.miss),e.acc.position.y=e.judge.height,e.perfect.position.y=e.acc.position.y+e.acc.height,e.good.position.y=e.perfect.position.y+e.perfect.height,e.bad.position.y=e.good.position.y+e.good.height,e.miss.position.y=e.bad.position.y+e.bad.height,e.container.position.set(8),pixi.stage.addChild(e.container),sprites.judgeRealTime=e}pixi.ticker.add(CalculateChartActualTime),settings.clickAnimate&&pixi.ticker.add(CalculateClickAnimateActualTime),_chart.audio.baseLatency=_chart.audio.context.audioContext.baseLatency||0;{let e=0,t=function(){e+=1/pixi.ticker.FPS,sprites.headInfos.position.y<0?(sprites.headInfos.position.y=-sprites.headInfos.height+sprites.headInfos.height*(e/.5),sprites.headInfos.alpha=e/.5*1):(sprites.headInfos.position.y=0,sprites.headInfos.alpha=1),0<sprites.footInfos.position.y?(sprites.footInfos.position.y=sprites.headInfos.height-sprites.headInfos.height*(e/.5),sprites.footInfos.alpha=e/.5*1):(sprites.footInfos.position.y=0,sprites.footInfos.alpha=1),sprites.titlesBig.alpha<1&&e<5&&(sprites.titlesBig.alpha+=2/pixi.ticker.FPS),0<sprites.titlesBig.alpha&&5.5<=e&&(sprites.titlesBig.alpha-=2/pixi.ticker.FPS),6<=e&&(sprites.titlesBig.alpha=0,stat.isTransitionEnd=!0,global.audio=_chart.audio.play({start:0,volume:settings.musicVolume}),stat.isPaused&&_chart.audio.pause(),pixi.ticker.remove(t))};for(var i in setTimeout(()=>{stat.isTransitionEnd=!1,pixi.ticker.add(t)},1e3),textures.sound)textures.sound[i].play({volume:0})}function n(e){let t={x:0,y:0};return fullscreen.check(pixi.view)?(t.x=e.clientX,t.y=e.clientY):(t.x=e.pageX-pixi.view.offsetLeft,t.y=e.pageY-pixi.view.offsetTop),t}document.getElementById("game-btn-pause").innerHTML='<i class="mdui-icon material-icons">&#xe034;</i> 暂停',settings.showPerformanceIndicator&&(sprites.performanceIndicator=new Stats,sprites.performanceIndicator.showPanel(1),document.body.appendChild(sprites.performanceIndicator.dom),sprites.performanceIndicator.dom.style.position="fixed",sprites.performanceIndicator.dom.style.top="0px",sprites.performanceIndicator.dom.style.left="unset",sprites.performanceIndicator.dom.style.right="0px")}else mdui.alert("谱面音频正在努力装载中，请稍等一会再试！<br>如果你持续收到该消息，请检查音频文件。","前方高能");else mdui.alert("你还没有选择一个谱面，请选择一个谱面！","前方高能",()=>{switchPanel(2)})}function setCanvasFullscreen(e=!1){pixi&&pixi.view&&(stat.isFullscreen=!0,fullscreen.toggle(pixi.view,!!e||(!fullscreen.enabled||2==fullscreen.type)))}function gamePause(){pixi&&_chart.audio&&(stat.isPaused?(global.audio=_chart.audio.play({start:_chart.audio.duration*global.audio.progress,volume:settings.musicVolume}),sprites.comboText.children[1].text=settings.autoPlay?"Autoplay":"combo",stat.isPaused=!1,document.getElementById("game-btn-pause").innerHTML='<i class="mdui-icon material-icons">&#xe034;</i> 暂停'):(_chart.audio.pause(),sprites.comboText.children[1].text="Paused",stat.isPaused=!0,document.getElementById("game-btn-pause").innerHTML='<i class="mdui-icon material-icons">&#xe037;</i> 继续'))}function gameRestart(){if(pixi&&stat.isTransitionEnd&&!stat.isRetrying){stat.isRetrying=!0;pixi.renderer.fixedWidth,pixi.renderer.fixedWidthOffset;var i,e,t,n,s=pixi.renderer.noteSpeed,o=pixi.renderer.noteScale,r=pixi.renderer.resolution;stat.isPaused=!1,_chart.audio.stop(),pixi.ticker.remove(CalculateChartActualTime),sprites.ui.end&&(sprites.ui.end.container.destroy(),sprites.ui.end=null);for(i of sprites.containers){i.position.set(pixi.renderer.realWidth/2,pixi.renderer.realHeight/2),i.angle=0,i.children[0].alpha=0,i.children[0].tint=settings.showApStatus?16772256:16777215;for(let t=1;t<i.children.length;t++)if(i.children[t]){let e=i.children[t];if(e.position.y=0,e.speedNotes&&0<e.speedNotes.length)for(var a of e.speedNotes)a.position.y=a.offsetY*s*a.speed*e.noteDirection*-1}}for(e of sprites.totalNotes)e.alpha=1,e.visible=!0,e.score=0,e.accType=0,e.isScored=!1,e.isProcessed=!1,e.isPressing=!1,e.pressTime=null,3==e.type&&(t=e.offsetY*s,n=e.holdLength*s*r/(o*r),e.children[1].height=n,e.children[2].position.y=-n,e.isAbove?e.position.y=-t:e.position.y=t);sprites.headInfos.position.y=-sprites.headInfos.height,sprites.footInfos.position.y=sprites.headInfos.height,sprites.comboText.alpha=0,sprites.comboText.children[0].text="0",sprites.comboText.children[1].text=settings.autoPlay?"Autoplay":"combo",sprites.scoreText.text="0000000",judgements=new Judgements,global.audio=null,score.init(sprites.totalNotes.length,settings.challengeMode),pixi.ticker.add(CalculateChartActualTime),_chart.audio.baseLatency=_chart.audio.context.audioContext.baseLatency||0;{let e=0,t=function(){e+=1/pixi.ticker.FPS,sprites.headInfos.position.y<0?(sprites.headInfos.position.y=-sprites.headInfos.height+sprites.headInfos.height*(e/.5),sprites.headInfos.alpha=e/.5*1):(sprites.headInfos.position.y=0,sprites.headInfos.alpha=1),0<sprites.footInfos.position.y?(sprites.footInfos.position.y=sprites.headInfos.height-sprites.headInfos.height*(e/.5),sprites.footInfos.alpha=e/.5*1):(sprites.footInfos.position.y=0,sprites.footInfos.alpha=1),sprites.titlesBig.alpha<1&&e<5&&(sprites.titlesBig.alpha+=2/pixi.ticker.FPS),0<sprites.titlesBig.alpha&&5.5<=e&&(sprites.titlesBig.alpha-=2/pixi.ticker.FPS),6<=e&&(sprites.titlesBig.alpha=0,stat.isTransitionEnd=!0,global.audio=_chart.audio.play({start:0,volume:settings.musicVolume}),stat.isPaused&&_chart.audio.pause(),pixi.ticker.remove(t))};setTimeout(()=>{stat.isTransitionEnd=!1,stat.isRetrying=!1,pixi.ticker.add(t)},200)}document.getElementById("game-btn-pause").innerHTML='<i class="mdui-icon material-icons">&#xe034;</i> 暂停'}}PIXI.CanvasRenderer.registerPlugin("graphics",PIXI.CanvasGraphicsRenderer),PIXI.CanvasRenderer.registerPlugin("sprite",PIXI.CanvasSpriteRenderer),Loader.add([{name:"tap",url:"./img/Tap.png"},{name:"tap2",url:"./img/Tap2.png"},{name:"tapHl",url:"./img/TapHL.png"},{name:"drag",url:"./img/Drag.png"},{name:"dragHl",url:"./img/DragHL.png"},{name:"flick",url:"./img/Flick.png"},{name:"flickHl",url:"./img/FlickHL.png"},{name:"holdHead",url:"./img/HoldHead.png"},{name:"holdHeadHl",url:"./img/HoldHeadHL.png"},{name:"holdBody",url:"./img/Hold.png"},{name:"holdBodyHl",url:"./img/HoldHL.png"},{name:"holdEnd",url:"./img/HoldEnd.png"},{name:"holdEndHl",url:"./img/HoldEndHL.png"},{name:"judgeLine",url:"./img/JudgeLine.png"},{name:"clickRaw",url:"./img/clickRaw128.png"},{name:"songNameBar",url:"./img/SongsNameBar.png"},{name:"progressBar",url:"./img/ProgressBar.png"},{name:"judgeIconFalse",url:"./img/judgeIcons/false.png"},{name:"judgeIconC",url:"./img/judgeIcons/c.png"},{name:"judgeIconB",url:"./img/judgeIcons/b.png"},{name:"judgeIconA",url:"./img/judgeIcons/a.png"},{name:"judgeIconS",url:"./img/judgeIcons/s.png"},{name:"judgeIconV",url:"./img/judgeIcons/v.png"},{name:"judgeIconPhi",url:"./img/judgeIcons/phi.png"},{name:"soundTap",url:"./sound/Hitsound-Tap.ogg"},{name:"soundDrag",url:"./sound/Hitsound-Drag.ogg"},{name:"soundFlick",url:"./sound/Hitsound-Flick.ogg"}]).load(function(e){for(const n in e.resources)if(n.indexOf("sound")<=-1&&n.indexOf("judgeIcon")<=-1){if(textures[n]=e.resources[n].texture,"clickRaw"==n){let t=[];for(let e=0;e<Math.floor(textures[n].height/textures[n].width);e++){var i=new PIXI.Rectangle(0,e*textures[n].width,textures[n].width,textures[n].width),i=new PIXI.Texture(textures[n].baseTexture,i);t.push(i)}textures[n]=t}}else 0<=n.indexOf("judgeIcon")?textures.judgeIcon[n.replace("judgeIcon","").toLowerCase()]=e.resources[n].texture:(textures.sound[n.replace("sound","").toLowerCase()]=e.resources[n].sound,textures.sound[n.replace("sound","").toLowerCase()].play({volume:0}))});